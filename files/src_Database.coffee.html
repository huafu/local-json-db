<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/Database.coffee - Local JSON DB</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="Local JSON DB"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.3</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/CoreObject.html">CoreObject</a></li>
            
                <li><a href="../classes/Database.html">Database</a></li>
            
                <li><a href="../classes/Model.html">Model</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src/Database.coffee</h1>

<div class="file">
    <pre class="code prettyprint linenums">
fs = require &#x27;fs&#x27;
sysPath = require &#x27;path&#x27;

mkdirp = require &#x27;mkdirp&#x27;

utils = require &#x27;./utils&#x27;
CoreObject = require &#x27;./CoreObject&#x27;
MergedRecordStore = require &#x27;./MergedRecordStore&#x27;
Model = require &#x27;./Model&#x27;

Class = null

###*
  The main class of the &#x60;local-json-db&#x60;, representing a database with one or more layers

  @since 0.0.2
  @class Database
  @extends CoreObject
  @constructor
  @example
    &#x60;&#x60;&#x60;js
    var db = new Database();
    var record = db.createRecord({name: &#x27;Huafu&#x27;});
    record.age = 31;
    db.updateRecord(record);
    console.log(db.find(&#x27;user&#x27;, record.id));
    // will output {id: 1, name: &#x27;Huafu&#x27;, age: 31}
    db.save();
    &#x60;&#x60;&#x60;
###
class Database extends CoreObject
  ###*
    The base path
    @since 0.0.2
    @private
    @property _basePath
    @type String
    @default &quot;./json.db&quot;
  ###
  _basePath: null
  ###*
    Configuration options
    @since 0.0.2
    @private
    @property _config
    @type Object
    @default {deletedAtKey: &quot;__deleted&quot;}
  ###
  _config: null
  ###*
    Array of all layers (overlays) path
    @since 0.0.2
    @private
    @property _layers
    @type Array&lt;String&gt;
    @default [this._baseBath]
  ###
  _layers: null
  ###*
    Loaded models, indexed by their bare name
    @since 0.0.2
    @private
    @property _models
    @type Object&lt;Model&gt;
    @default null
  ###
  _models: null


  ###*
    Constructs a new instance of {{#crossLink &quot;Database&quot;}}{{/crossLink}}

    @since 0.0.2
    @method constructor
    @param {String} [basePath=&quot;./json.db&quot;]            the base path for the db files, hosting base JSON files of any added overlay
    @param {Object} [config={}]                       the configuration options
    @param {String} [config.createdAtKey]             name of the key to use as the &#x60;createdAt&#x60; flag for a record
    @param {String} [config.updatedAtKey]             name of the key to use as the &#x60;updatedAt&#x60; flag for a record
    @param {String} [config.deletedAtKey=&quot;__deleted&quot;] name of the key to use as the &#x60;deletedAt&#x60; flag for a record
  ###
  constructor: (basePath = &#x27;./json.db&#x27;, config = {}) -&gt;
    @_basePath = sysPath.resolve basePath
    @_config = utils.defaults {}, config
    @_layers = [@_basePath]
    # keep to null so we know if we are loaded or not, in which case adding/removing layers would be impossible
    @_models = null
    @lockProperties &#x27;_basePath&#x27;, &#x27;_config&#x27;, &#x27;_layers&#x27;


  ###*
    Add an overlay on top of all layers (the latest is the one used first, then come the others in order until the base)

    @since 0.0.2
    @method addOverlay
    @param {String} path  the path where to read/write JSON files of records, relative to the base path
    @chainable
  ###
  addOverlay: (path) -&gt;
    @assertNotLoaded(&#x27;cannot add overlay&#x27;)
    if utils.isArray(path)
      path = sysPath.join(path...)
    path = sysPath.resolve @_basePath, path
    @assert path not in @_layers, &quot;you cannot add twice the same path for 2 different overlays&quot;
    @_layers.push path
    @


  ###*
    Creates a new record in the database

    @since 0.0.2
    @method createRecord
    @param {String} modelName name of the model
    @param {Object} record    attributes of the record to create
    @return {Object}          a copy of the newly created model with read-only &#x60;id&#x60;
  ###
  createRecord: (modelName, record) -&gt;
    @modelFactory(modelName).create record


  ###*
    Updates a record with the given attributes

    @since 0.0.2
    @method updateModel
    @param {String} modelName   name of the model
    @param {String|Number} [id] id of the record to update, if not given it must be in &#x60;record&#x60;
    @param {Object} record      attributes of the record to update
    @return {Object}            a copy of the updated record
  ###
  updateRecord: (modelName, id, record) -&gt;
    mdl = @modelFactory(modelName)
    mdl.update.apply mdl, [].slice.call(arguments, 1)


  ###*
    Deletes a record given its id

    @since 0.0.2
    @method deleteRecord
    @param {String} modelName name of the model
    @param {String|Number} id id of the record to delete
    @return {Object}          a copy of the old record which has been deleted
  ###
  deleteRecord: (modelName, id) -&gt;
    @modelFactory(modelName).delete id


  ###*
    Finds a record by id

    @since 0.0.2
    @method find
    @param {String} modelName   name of the model
    @param {String|Number} id   id of the record to find
    @return {Object|undefined}  copy of the record if found, else &#x60;undefined&#x60;
  ###
  find: (modelName, id) -&gt;
    @modelFactory(modelName).find id


  ###*
    Finds many record given a list of ids. If some records are not found, they&#x27;ll just be filtered out
    of the resulting array

    @since 0.0.2
    @method findMany
    @param {String} modelName         name of the model
    @param {Array|String|Number} ids* id of each record to find, or one array with all record ids
    @return {Array&lt;Object&gt;}           array containing all found records
  ###
  findMany: (modelName, ids...) -&gt;
    @modelFactory(modelName).findMany ids...


  ###*
    Finds records using a filter (either function or set of properties to match)

    @since 0.0.2
    @method findQuery
    @param {String} modelName       name of the model
    @param {Object|Function} filter attributes to match or a function used to filter records
    @param {Object} [thisArg]       will be used as the context to run the filter function
    @return {Array&lt;Object&gt;}         array with all records which matched
  ###
  findQuery: (modelName, filter, thisArg) -&gt;
    @modelFactory(modelName).findQuery filter, thisArg


  ###*
    Finds all records in the database

    @since 0.0.2
    @method findAll
    @param {String} modelName name of the model
    @return {Array&lt;Object&gt;}   array containing all records of the given model
  ###
  findAll: (modelName) -&gt;
    @modelFactory(modelName).findAll()


  ###*
    Counts all records of a given model

    @since 0.0.2
    @method count
    @param {String} modelName name of the model to count records
    @return {Number}          the total number of records
  ###
  count: (modelName) -&gt;
    @modelFactory(modelName).count()


  ###*
    Saves in the top overlay&#x27;s path the records that have been created/modified or deleted

    @since 0.0.2
    @method save
    @chainable
  ###
  save: -&gt;
    if @isLoaded()
      models = []
      for own name, model of @_models
        @_saveModelStore name, model
        @emit &#x27;model.store.saved&#x27;, model
        models.push model
      @emit &#x27;db.saved&#x27;, model
    @


  ###*
    Whether the database has been loaded or not (in that case no overlay can be added)

    @since 0.0.2
    @method isLoaded
    @return {Boolean} returns &#x60;true&#x60; if the db is loaded, else &#x60;false&#x60;
  ###
  isLoaded: -&gt;
    Boolean(@_models)


  ###*
    Loads the database (you don&#x27;t need to call this method, it&#x27;ll be automatically called when needed)

    @since 0.0.2
    @method load
    @param {Boolean} force  whether to force a reload in case it has already been loaded previously
    @chainable
  ###
  load: (force) -&gt;
    if force or not @isLoaded()
      @unload()
      @_models = {}
    @


  ###*
    Unloads the database and all the records. **This does NOT save anything**

    @since 0.0.2
    @method unload
    @chainable
  ###
  unload: -&gt;
    if @isLoaded()
      for own name, model of @_models
        model.destroy()
      @_models = null
    @


  ###*
    Destroy and free the db object

    @since 0.0.2
    @method destroy
  ###
  destroy: -&gt;
    @unload()
    super


  ###*
    Get the {{#crossLink &quot;Model&quot;}}{{/crossLink}} instance given a model name

    @since 0.0.2
    @method modelFactory
    @param {String} modelName name of the model to get the instance
    @return {Model}           the model object
  ###
  modelFactory: (modelName) -&gt;
    @load()
    name = @_modelName(modelName)
    unless (model = @_models[name])
      @_models[name] = model = new Model(@, name, @_createModelStore(name))
      @emit &#x27;model.store.loaded&#x27;, model
    model


  ###*
    Used to transform a model name into its store&#x27;s JSON file name

    @since 0.0.2
    @method modelNameToFileName
    @param {String} modelName name of the model
    @return {String}          name of the file, sanitized and normalized
  ###
  modelNameToFileName: (modelName) -&gt;
    Model.assertValidModelName modelName
    &quot;#{ utils.kebabCase(utils.pluralize modelName) }.json&quot;


  ###*
    Asserts that the DB hasn&#x27;t been loaded yet, or throw an error

    @since 0.0.2
    @method assertNotLoaded
    @param {String} msg additional message to add in the error
    @chainable
  ###
  assertNotLoaded: (msg) -&gt;
    @assert not @isLoaded(), &quot;the database is already loaded#{if msg then &quot;, #{msg}&quot; else &#x27;&#x27;}&quot;


  ###*
    Normalize a model name

    @since 0.0.2
    @method _modelName
    @private
    @param {String} name  name of the model to normalize
    @return {String}      normalized name
  ###
  _modelName: (name) -&gt;
    Model._modelName name


  ###*
    Creates the store for a given model

    @since 0.0.2
    @private
    @method _createModelStore
    @param {String} name        name of the model
    @return {MergedRecordStore} the newly created store for the given model
  ###
  _createModelStore: (modelName) -&gt;
    file = @modelNameToFileName @_modelName modelName
    stores = []
    for path in @_layers.slice().reverse()
      path = sysPath.join path, file
      if fs.existsSync(path)
        data = fs.readFileSync path, encoding: &#x27;utf8&#x27;
        data = JSON.parse data
        stores.push data
      else
        stores.push {config: {}, records: []}
    main = stores.shift()
    store = new MergedRecordStore(main.records, utils.defaults({}, @_config, main.config))
    for s in stores
      store.addLayer s.records, utils.defaults({}, main.config, s.config)
    store


  ###*
    Saves the store of a given model to disk

    @since 0.0.2
    @private
    @method _saveModelStore
    @param {String} name  name of the model
    @param {Model} model  model instance
    @return {String}      the full path of the file that has been saved
  ###
  _saveModelStore: (name, model) -&gt;
    file = @modelNameToFileName @_modelName name
    top = @_layers[@_layers.length - 1]
    path = sysPath.join top, file
    store = model._store
    if store.countRecords(yes) is 0
      fs.unlinkSync(path) if fs.existsSync(path)
    else
      mkdirp.sync top
      fs.writeFileSync path, JSON.stringify(store.export())
    path


module.exports = Class = Database

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
